//  $Id: richdbc.C,v 1.62 2009/04/28 15:19:11 mdelgado Exp $
#include"richdbc.h"
#include<math.h>
#include"richid.h"

geant RICHDB::_RICradpos=RICradposs;
integer RICHDB::_Nph=0;

// defaults
geant RICHDB::wave_length[RICmaxentries]={608.696, 605.797, 602.899, 600.000, 595.652, 591.304,
					  585.507, 578.261, 573.913, 568.116, 563.768, 556.522,
					  550.725, 543.478, 536.232, 528.986, 520.739, 511.594,
					  502.899, 494.203, 482.609, 471.014, 459.42,  447.826,
					  431.884, 426.087, 404.348, 391.304, 376.812, 369.565,
					  355.012, 340.58,  328.986, 314.493, 304.348, 295.304, 
					  288.406, 284.058, 279.71,  275.812, 272.464, 270.014,
					  268.116, 266.667};

geant RICHDB::rad_index=1.0529;
geant RICHDB::naf_index=1.33;

// Fused SiO2 scaled to n=1.14
geant RICHDB::index[RICmaxentries]={1.136,   1.13602, 1.13605, 1.13608, 1.13612, 1.13617,
				    1.13623, 1.13631, 1.13635, 1.13642, 1.13647, 1.13656,
				    1.13663, 1.13672, 1.13681, 1.13691, 1.13703, 1.13717,
				    1.13731, 1.13745, 1.13766, 1.13787, 1.13811, 1.13837,
				    1.13875, 1.1389,  1.13953, 1.13996, 1.1405,  1.14079,
				    1.14144, 1.14217, 1.14284, 1.1438,  1.14456, 1.14532,
				    1.14596, 1.14639, 1.14684, 1.14727, 1.14766, 1.14795,
				    1.14818, 1.14837};



geant RICHDB::naf_index_table[RICmaxentries]={1.32526,1.32531,1.32535,1.32540,1.32547,
					      1.32555,1.32565,1.32578,1.32587,1.32598,
					      1.32607,1.32622,1.32634,1.32650,1.32667,
					      1.32684,1.32705,1.32730,1.32754,1.32780,
					      1.32817,1.32857,1.32901,1.32948,1.33019,
					      1.33047,1.33165,1.33246,1.33348,1.33403,
					      1.33528,1.33669,1.33798,1.33984,1.34134,
					      1.34283,1.34408,1.34493,1.34583,1.34667,
					      1.34744,1.34802,1.34849,1.34885};


// Best fit to current measures: AGL abs length
geant RICHDB::abs_length[RICmaxentries]={100.,100.,100.,100.,100.,
					 100.,100.,100.,100.,100.,
					 100.,100.,100.,100.,100.,
					 100.,100.,100.,100.,100.,
					 100.,100.,100.,100.,100.,
					 100.,100.,100.,100.,100.,
					 100.,100.,100.,100.,100.,
					 100.,100.,100.,100.,100.,
					 100.,100.,100.,100.};



geant RICHDB::naf_abs_length[RICmaxentries]={36.5383,36.1793,35.8222,35.4667,34.9367,
					     34.4106,33.7151,32.8555,32.3448,31.6699,
					     31.1682,30.3407,29.6864,28.8781,28.0806,
					     27.2939,26.4115,25.4492,24.5502,23.6665,
					     22.5124,21.3856,20.2864,19.2146,17.7859,
					     17.2792,15.4405,14.3837,13.2504,12.6999,
					     11.6268,10.6057, 9.8163, 8.8685, 8.2308,
					     7.6803, 7.2717, 7.0193, 6.7707, 6.5513,
					     6.3653, 6.2307, 6.1272, 6.0488};


integer RICHDB::agl_media=0;
integer RICHDB::naf_media=0;

// PMT quantum eff. from Hamamatsu
geant RICHDB::eff[RICmaxentries]={1.296, 1.476, 1.717, 1.853, 2.041, 2.324, 2.646, 3.214, 3.504,
				  3.904, 4.350, 5.171, 5.518, 6.420, 7.153, 8.143, 9.271,10.330,
				  11.509,12.280,13.981,15.244,16.984,18.122,19.337,20.191,20.633,
				  20.633,20.633,20.633,20.633,20.010,18.923,17.355,16.266,14.918, 
				  13.682,11.509,10.555, 8.321, 7.153, 6.282, 6.148, 4.953};

geant RICHDB::pmt_p[RICmaxpmts][2]; // Table with PMT positions



// PMT photocathode window
geant RICHDB::pmtw_index=1.458;


// Measured abs. length for Bicron-BC800 plastic.
/*
geant RICHDB::lg_abs[RICmaxentries]={100.000,100.000,100.000,100.000,100.000,
				     100.000,100.000,100.000,100.000,100.000,
				     100.000,100.000,100.000,100.000,100.000,
				     100.000,100.000,100.000,100.000,100.000,
				     100.000,100.000,100.000,100.000,100.000,
				     100.000,83.6568,61.6296,24.8616,14.1085,
				     7.0524, 5.3358, 5.2303, 5.0741, 2.8348,
				     0.7004, 0.2304, 0.0554, 0.0554, 0.0554,
				     0.0554, 0.0554, 0.0554, 0.0554};
*/
geant RICHDB::lg_abs[RICmaxentries]={100.000,100.000,100.000,100.000,100.000,
				     100.000,100.000,100.000,100.000,100.000,
				     100.000,100.000,100.000,100.000,100.000,
				     100.000,100.000,100.000,100.000,100.000,
				     100.000,100.000,100.000,100.000,100.000,
				     100.000,100.000,100.000,100.000,77.3558,
				     45.6987,28.8274,20.7165,10.7713, 6.4616,
				     3.9870, 2.7432, 2.1056, 1.5412, 1.1739,
				     0.9601, 0.7881, 0.7336, 0.6433};

geant RICHDB::lg_index[RICmaxentries]={1.49,1.49,1.49,1.49,1.49,1.49,1.49,1.49,1.49,1.49,
				       1.49,1.49,1.49,1.49,1.49,1.49,1.49,1.49,1.49,1.49,
				       1.49,1.49,1.49,1.49,1.49,1.49,1.49,1.49,1.49,1.49,
				       1.49,1.49,1.49,1.49,1.49,1.49,1.49,1.49,1.49,1.49,
				       1.49,1.49,1.49,1.49};
				       

geant RICHDB::support_foil_abs[RICmaxentries]={100.000,100.000,100.000,100.000,100.000,
					       100.000,100.000,100.000,100.000,100.000,
					       100.000,100.000,100.000,100.000,100.000,
					       100.000,100.000,100.000,100.000,100.000,
					       100.000,100.000,100.000,100.000,100.000,
					       100.000,100.000,100.000,24.2986,20.6782,
					       11.0866, 7.2738, 5.5707, 4.4291, 3.5494,
					       2.1707, 0.9189, 0.4978, 0.2674, 0.1544,
					       0.1088, 0.0871, 0.0726, 0.0598};


geant RICHDB::support_foil_index[RICmaxentries]={1.46,1.46,1.46,1.46,1.46,1.46,1.46,1.46,1.46,1.46,
						 1.46,1.46,1.46,1.46,1.46,1.46,1.46,1.46,1.46,1.46,
						 1.46,1.46,1.46,1.46,1.46,1.46,1.46,1.46,1.46,1.46,
						 1.46,1.46,1.46,1.46,1.46,1.46,1.46,1.46,1.46,1.46,
						 1.46,1.46,1.46,1.46};

integer RICHDB::entries=RICmaxentries;
//geant RICHDB::top_radius=60.0;                 // Top mirror radius
//geant RICHDB::bottom_radius=66.82;             // Bottom mirror radius
//geant RICHDB::rich_height=45.8;  // Mirror height (for historical reasons it is quoted rich height)

/*********** updated numbers */
geant RICHDB::top_radius=60.10;      // Top mirror radius
geant RICHDB::bottom_radius=67.00;   // Bottom mirror radius
geant RICHDB::rich_height=46.32;     // Mirror height (for historical reasons it is quoted rich height)
/****************************/

geant RICHDB::hole_radius[2]={63.8/2.,64.3/2}; // half ECAL hole side length (it is not symmetric)
geant RICHDB::inner_mirror_height=50;          // UNUSED
geant RICHDB::rad_clarity=0.0055;              // Radiator clarity: updated 10/28/04
geant RICHDB::scatprob=.19;                    // Probability of surface scattering accroding to C. Delgado model
geant RICHDB::scatang=14e-3;                   // Scattered angle (rad) according to C. Delgado model 
geant RICHDB::eff_rad_clarity=0.0055;          // clarity used in charge recosntruction

geant RICHDB::rad_radius=60.0;                 // Radiator radius
geant RICHDB::rad_agl_height=2.5;              // Radiator agl thickness
geant RICHDB::rad_height=3;                    // Radiator support structure height
geant RICHDB::naf_height=0.5;                  // NaF radiator thickness
geant RICHDB::rad_length=11.5;                 // AGL Radiator tile side length
geant RICHDB::naf_length=8.52;                 // NAF Radiator tile side length
geant RICHDB::lg_height=3.0;                   // Light guide height withou the fixing foil
geant RICHDB::lg_length=3.4;                   // Side length of light guide top (Called lg_length in the standalone version)
geant RICHDB::lg_bottom_length=1.77;           // Side length on the bottom
geant RICHDB::inner_pixel=0.38;                // Inner pixel size
geant RICHDB::foil_height=0.1;                 // Foil thickness
//geant RICHDB::foil_index=1.49;                 // Foil refractive index
geant RICHDB::foil_index=1.46;                 // Foil refractive index


integer RICHDB::total=0;

geant RICHDB::ped=0.;                         // Default pedestal value (ADC counts)
geant RICHDB::sigma_ped=0.5335;               // Default pedestal width
geant RICHDB::peak=23.04;                     // Default gain
geant RICHDB::sigma_peak=12.10;               // Witdh of the single p.e.
geant RICHDB::c_ped=2.;                       // N od ADC counts for detection threshold

// Measure in the prototype
geant RICHDB::prob_noisy=8.e-5;
geant RICHDB::prob_dark=4.e-5;   

// Some counters
integer RICHDB::nphgen=0;
integer RICHDB::nphrad=0;
integer RICHDB::nphbas=0;
integer RICHDB::numrefm=0;
integer RICHDB::numrayl=0;


// Book some histograms
void RICHDB::bookhist(){
#ifdef __AMSDEBUG__
  dump();
  cout <<"RICH BOOKING"<<endl;
  HBOOK1(123456,"Error de los directos",50,-1.,1.,0.);
  HBOOK1(123457,"Error de los reflejados",50,-1.,1.,0.);
  HBOOK1(123000,"Generados",300,0.,100.,0.);
  HBOOK1(123001,"Radiador",300,0.,100.,0.);
  HBOOK1(123002,"Base",300,0.,100.,0.);
  HBOOK1(123003,"Detectados",300,0.,100.,0.);
  HBOOK1(123100,"LG TRAN",100,0.,1.,0.);
  HBOOK1(1231001,"f",100,0.,1.,0.);
  HBOOK1(1231002,"lglength",100,0.,6.,0.);
  HBOOK1(123100,"Numero de hits ",300,0.,50.,0.);
  HBOOK1(123100,"Numero de hits reflejados",300,0.,50.,0.);
  HBOOK1(123100,"Numero de hits sin reflejar",300,0.,50.,0.);
  HBOOK2(124000,"Posicion de los PMT",300,-70.,70.,300,-70.,70.,0.);
  HBOOK2(124010,"Posicion de los PMT",300,-60.,60.,300,-60.,60.,0.);
  HBOOK1(12345,"Probabilidad de scattering",2,0.,2.,0.);
  HBOOK1(12346,"Angulo ph",50,0.,3.141592,0.);
  HBOOK1(12347,"Angulo th",100,0.,2e-1,0.);
#endif 

}

// Recompute some vars 
void RICHDB::mat_init(){
// Update chromatic dispersion if the radiator index is different from 1.14
// Scaled from fused SiO2
  static int called=0;


  if(!called){
#pragma omp barrier
#pragma omp master
    {
#ifdef __AMSDEBUG__
    //    if(RICHDB::rad_index!=1.14) 
    //      cout <<"Energia     Indice"<<endl
    //	   <<"-------     ------"<<endl;
#endif

    if(RICHDB::rad_index!=1.14)
      for(integer i=0;i<RICmaxentries;i++){
	if(RICHDB::index[i]<1.) continue;
	RICHDB::index[i]=1.+(RICHDB::index[i]-1.)*(RICHDB::rad_index-1.)/0.14;
      }
    called=1;
    }
#pragma omp barrier
  }
}



// Aerogel density

geant RICHDB::aerogel_density(){
  geant water_conc=0.;
  geant methanol_conc=0.;

  // J.Phys D 27(1994)414: Unused
  //  return (RICHDB::rad_index-1.)/(0.19+0.31*water_conc+0.38*methanol_conc);

  // Matsushita
  return (RICHDB::rad_index-1.)/0.28;
}


/// Now Some functions for the rich geometry

geant RICHDB::total_height()
{

  return rad_height+foil_height+RICradmirgap+rich_height+
    RIClgdmirgap+RICpmtsupportheight;
}

geant RICHDB::pmtb_height()
{

  return RICpmtlength+RICeleclength+lg_height+RICpmtfoil;
}

geant RICHDB::mirror_pos()
{

  return rad_height+foil_height+RICradmirgap+rich_height/2.;
}

geant RICHDB::rad_pos()
{
  return rad_height/2;
}

geant RICHDB::pmt_pos() // In RICH
{  

  return rad_height+foil_height+RICradmirgap+rich_height+
             RIClgdmirgap+pmtb_height()/2.;
}

geant RICHDB::elec_pos() // In PMT box
{

  return cato_pos()+RICpmtlength/2.;
}

geant RICHDB::cato_pos() // In PMT box
{

  return lg_pos()+(lg_height+RICotherthk)/2;
}

geant RICHDB::lg_pos()
{
  return -(RICpmtlength+RICeleclength)/2+RICpmtfoil/2.;
}

geant RICHDB::shield_pos(){

  return elec_pos()-RICotherthk/2.;
}

geant RICHDB::lg_mirror_angle(integer i)
{

  if(i==1)
    return atan2(geant(lg_length/2.-
		       RICepsln/2-                // Patch for G4
       (lg_bottom_length/2.+RIClgthk_bot/2.)),
		 lg_height)*180./3.14159265358979323846;


  if(i==2)
    return atan2(geant(lg_length/4.-
        (RIClgthk_bot+inner_pixel)),
		 lg_height)*180./3.14159265358979323846;


  return 0;
}

geant RICHDB::lg_mirror_pos(integer i)
{

  if(i==1)
    return lg_bottom_length/2.+RIClgthk_bot/2.
           +lg_height/2.*tan(lg_mirror_angle(1)*3.1415926/180.);

  if(i==2)
    return RIClgthk_bot+inner_pixel+
            lg_height/2.*tan(lg_mirror_angle(2)*3.1415926/180.);


  return 0;
}

geant RICHDB::x(integer id){return RichPMTsManager::GetChannelPos(id,0);};
geant RICHDB::y(integer id){return RichPMTsManager::GetChannelPos(id,1);};

integer RICHDB::detcer(geant photen)
{
  return RichPMTsManager::detcer(photen);
}
   

geant RICHDB::max_step(){
  AMSmceventg dummy(GCKINE.ikine,0.,AMSPoint(),AMSDir());
  number charge=dummy.getcharge();

  if(charge==0) return 1000.;
  geant dndl=370*(1-1/RICHDB::rad_index/RICHDB::rad_index)*
        197.327*6.28*(1/RICHDB::wave_length[RICmaxentries-1]
	-1/RICHDB::wave_length[0])*charge*charge;
  geant max=RICmaxphotons/dndl;
  return max;
}


geant RICHDB::mean_height(){
  // Computes the mean emission point inside the radiator
  // of the detected photons.
  // The credits go to .... Elisa Lanciotti

  static geant value=0.0;
#pragma omp threadprivate(value)

  if(value) return value;

#ifdef __AMSDEBUG__
  //  cout<<"Computing mean height value"<<endl;  
#endif
  
  const integer steps=100;    // Number of steps for the approximation
  geant lambda,qeff,n,dl,l_scat=0,l_abs_rad,l_abs_lg;
  geant sum=0,densum=0;
  geant sum_index=0;

  for(integer i=0;i<RICmaxentries-1;i++){ // Integration in wave length
    lambda=(RICHDB::wave_length[i]+RICHDB::wave_length[i+1])/2.;
    qeff=(RICHDB::eff[i]+RICHDB::eff[i+1])/2.;
    n=(RICHDB::index[i]+RICHDB::index[i+1])/2.;
    dl=RICHDB::wave_length[i]-RICHDB::wave_length[i+1];
    if(rad_clarity==0. && l_scat!=1e6){
      cerr <<"RICHDB::mean_height : radiador clarity is zero."<<endl;
      l_scat=1e6;
    }else
      l_scat=(lambda/1000.)*(lambda/1000.)*(lambda/1000.)*(lambda/1000.)/
	rad_clarity;
    l_abs_rad=(RICHDB::abs_length[i]+RICHDB::abs_length[i+1])/2.;
    l_abs_lg=(RICHDB::lg_abs[i]+RICHDB::lg_abs[i+1])/2.;
    for(integer j=0;j<steps;j++){ // Integration in radiador thicknes
      geant x=rad_height*(geant(j)+0.5)/geant(steps);
      geant g=qeff/lambda/lambda/exp((rad_height-x)*
				     (1/l_scat+1/l_abs_rad))/
	exp(lg_height/l_abs_lg);
      sum+=dl*g*x;
      densum+=dl*g;
      sum_index+=dl*g*n;
    }
  }
  if(!densum){
    cerr<<"RICHDB::mean_height : Error"<<endl;
  }else{
    value=rad_height-sum/densum;

    RICHDB::rad_index=sum_index/densum;

    return value;
  }
  return -1;  // Codigo de error
}


void RICHDB::dump(){
  // DUMP constant values
  cout <<"Dimensions:"<<endl<<
    "  RICradpos:  "<<RICHDB::RICradpos()<<endl<<
    "  RICaethk:  "<<RICaethk<<endl<<      
    "  RIClgthk:  "<<RIClgthk<<endl<<
    "  RIClgthk_top:  "<<RIClgthk_top<<endl<<
    "  RIClgthk_bot:  "<< RIClgthk_bot<<endl<< 
    "  RICmithk:  "<<RICmithk<<endl<<      
    "  RICradmirgap:  "<<RICradmirgap<<endl<<   
    "  RIClgdmirgap:  "<<RIClgdmirgap<<endl<<
    "  RICotherthk:  "<<RICotherthk<<endl;

  // Dump not constant 
  cout<<
    "  rad_clarity:  "<<rad_clarity<<endl<<
    "  rad_radius:  "<<rad_radius<<endl<<
    "  rad_height:  "<<rad_height<<endl<<
    "  rad_length:  "<<rad_length<<endl<<
    "  rad_index:  "<<rad_index<<endl<<
    "  foil_height:  "<<foil_height<<endl<<
    "  foil_index:  "<<foil_index<<endl<<
    //    "  rad_supthk:  "<<rad_supthk<<endl<<
    "  lg_height:  "<<lg_height<<endl<<
    "  lg_length:  "<<lg_length<<endl<<
    "  lg_bottom_length:  "<<lg_bottom_length<<endl<<
    "  inner_pixel:  "<<inner_pixel<<endl;


  // Dump functions
  cout <<
    "  total_height:  "<<total_height()<<endl<<
    "  pmtb_height:  "<<pmtb_height()<<endl<<
    "  mirror_pos:  "<<mirror_pos()<<endl<<
    "  rad_pos:  "<<rad_pos()<<endl<<
    "  pmt_pos:  "<<pmt_pos()<<endl<<
    "  elec_pos:  "<<elec_pos()<<endl<<
    "  cato_pos:  "<<cato_pos()<<endl<<
    "  lg_pos:  "<<lg_pos()<<endl<<
    "  shield_pos:  "<<shield_pos()<<endl;

 
  // Other stuff
  /*
  cout <<
    " LG top at "<<RICHDB::total_height()/2+AMSRICHIdGeom::pmt_pos(1,2)
    +RICHDB::lg_height/2.+RICpmtfoil-lg_pos()<<endl<<
    " Radiator bottom at "<<RICHDB::total_height()/2-RICHDB::rad_pos()-
    RICHDB::rad_height/2<<endl;
  */

}




// Light guide efficiency tables
/*
float RICHDB::lg_eff_tbl[RIC_NWND][RIC_NPHI][RIC_NTH]=
{0.924,0.912,0.893,0.877,0.846,0.822,0.781,0.720,0.669,0.521,0.331,0.126,0.028,0.011,0.013,0.000,0.000,0.000,0.000,0.000
,0.924,0.906,0.897,0.864,0.833,0.800,0.768,0.697,0.560,0.379,0.199,0.065,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000
,0.924,0.913,0.894,0.876,0.843,0.823,0.777,0.716,0.669,0.512,0.332,0.123,0.029,0.011,0.013,0.000,0.000,0.000,0.000,0.000
,0.923,0.920,0.905,0.889,0.863,0.844,0.806,0.743,0.736,0.646,0.462,0.227,0.074,0.025,0.024,0.000,0.000,0.000,0.000,0.000
,0.926,0.922,0.913,0.902,0.889,0.871,0.842,0.820,0.765,0.711,0.615,0.439,0.226,0.060,0.012,0.000,0.000,0.000,0.000,0.000
,0.928,0.926,0.922,0.920,0.918,0.900,0.869,0.855,0.818,0.786,0.723,0.627,0.422,0.261,0.149,0.035,0.000,0.015,0.000,0.000
,0.930,0.934,0.931,0.933,0.928,0.917,0.893,0.884,0.859,0.836,0.762,0.707,0.554,0.425,0.300,0.115,0.028,0.024,0.014,0.000
,0.930,0.937,0.936,0.928,0.921,0.925,0.917,0.890,0.868,0.836,0.808,0.760,0.674,0.483,0.260,0.101,0.021,0.000,0.000,0.000
,0.930,0.933,0.932,0.930,0.928,0.918,0.890,0.886,0.858,0.839,0.768,0.708,0.569,0.430,0.303,0.122,0.028,0.025,0.015,0.000
,0.929,0.929,0.925,0.917,0.919,0.899,0.869,0.855,0.817,0.782,0.723,0.624,0.424,0.261,0.148,0.037,0.000,0.014,0.000,0.000
,0.927,0.921,0.915,0.902,0.889,0.876,0.847,0.815,0.767,0.713,0.622,0.446,0.225,0.061,0.012,0.000,0.000,0.000,0.000,0.000
,0.921,0.919,0.900,0.887,0.862,0.845,0.801,0.741,0.737,0.656,0.463,0.221,0.069,0.022,0.023,0.000,0.000,0.000,0.000,0.000
,0.895,0.872,0.877,0.820,0.697,0.673,0.595,0.349,0.107,0.046,0.054,0.066,0.056,0.055,0.062,0.055,0.019,0.017,0.024,0.000
,0.893,0.875,0.854,0.838,0.753,0.617,0.475,0.308,0.157,0.061,0.032,0.031,0.031,0.028,0.021,0.016,0.000,0.000,0.000,0.000
,0.895,0.882,0.860,0.836,0.804,0.769,0.657,0.502,0.335,0.198,0.083,0.033,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000
,0.895,0.890,0.873,0.861,0.837,0.820,0.785,0.724,0.672,0.591,0.432,0.229,0.087,0.026,0.021,0.011,0.000,0.000,0.000,0.000
,0.897,0.899,0.896,0.884,0.874,0.868,0.855,0.840,0.807,0.769,0.735,0.672,0.540,0.351,0.169,0.048,0.000,0.000,0.000,0.000
,0.897,0.909,0.908,0.913,0.914,0.915,0.904,0.897,0.887,0.859,0.857,0.839,0.787,0.709,0.520,0.215,0.055,0.090,0.090,0.000
,0.903,0.914,0.919,0.921,0.930,0.928,0.925,0.920,0.916,0.898,0.891,0.880,0.856,0.797,0.649,0.419,0.157,0.154,0.161,0.000
,0.901,0.908,0.916,0.916,0.917,0.919,0.917,0.909,0.899,0.879,0.861,0.830,0.802,0.757,0.644,0.482,0.260,0.084,0.033,0.000
,0.900,0.908,0.908,0.909,0.905,0.894,0.873,0.862,0.839,0.810,0.760,0.676,0.553,0.402,0.307,0.161,0.055,0.024,0.018,0.000
,0.900,0.898,0.896,0.892,0.884,0.860,0.846,0.803,0.726,0.610,0.461,0.269,0.119,0.057,0.028,0.012,0.000,0.000,0.000,0.000
,0.894,0.887,0.877,0.889,0.856,0.776,0.727,0.653,0.526,0.323,0.145,0.058,0.039,0.043,0.042,0.042,0.034,0.017,0.000,0.000
,0.894,0.877,0.883,0.854,0.733,0.745,0.715,0.466,0.144,0.056,0.054,0.080,0.067,0.062,0.062,0.074,0.049,0.029,0.041,0.000
,0.858,0.846,0.817,0.704,0.522,0.378,0.254,0.121,0.049,0.037,0.049,0.047,0.046,0.044,0.036,0.023,0.010,0.000,0.000,0.000
,0.861,0.837,0.801,0.700,0.498,0.278,0.117,0.050,0.037,0.036,0.033,0.026,0.017,0.010,0.000,0.000,0.000,0.000,0.011,0.000
,0.862,0.848,0.820,0.697,0.518,0.377,0.248,0.117,0.048,0.039,0.049,0.045,0.043,0.045,0.034,0.024,0.000,0.000,0.000,0.000
,0.865,0.856,0.846,0.772,0.651,0.638,0.588,0.408,0.160,0.062,0.052,0.066,0.068,0.063,0.063,0.068,0.050,0.034,0.036,0.000
,0.869,0.864,0.863,0.867,0.840,0.781,0.741,0.708,0.641,0.507,0.348,0.214,0.110,0.064,0.053,0.055,0.057,0.056,0.056,0.000
,0.872,0.880,0.881,0.884,0.885,0.889,0.885,0.871,0.847,0.825,0.774,0.689,0.539,0.380,0.210,0.085,0.031,0.022,0.013,0.000
,0.880,0.886,0.892,0.900,0.908,0.910,0.910,0.906,0.898,0.881,0.875,0.870,0.844,0.803,0.673,0.424,0.191,0.137,0.141,0.000
,0.880,0.891,0.898,0.903,0.910,0.920,0.923,0.924,0.917,0.915,0.902,0.886,0.875,0.866,0.844,0.795,0.723,0.533,0.388,0.000
,0.880,0.892,0.896,0.898,0.908,0.908,0.907,0.905,0.897,0.879,0.876,0.869,0.840,0.799,0.673,0.429,0.195,0.137,0.135,0.000
,0.876,0.878,0.879,0.878,0.883,0.886,0.885,0.871,0.843,0.819,0.771,0.685,0.537,0.374,0.210,0.083,0.029,0.022,0.012,0.000
,0.870,0.863,0.862,0.866,0.840,0.784,0.754,0.729,0.666,0.516,0.344,0.210,0.111,0.064,0.052,0.054,0.056,0.056,0.054,0.000
,0.863,0.856,0.848,0.771,0.654,0.639,0.598,0.414,0.157,0.059,0.052,0.067,0.071,0.064,0.064,0.068,0.049,0.033,0.035,0.000};
*/
float RICHDB::lg_eff_tbl[RIC_NWND][RIC_NPHI][RIC_NTH]={
  0.932661,0.915575,0.881552,0.865367,0.825561,0.812413,0.751803,0.703525,0.628946,0.47485,0.259597,0.0866842,0.0172911,0.0119717,0.0121803,0.00153257,0,0,0,0,
  0.923716,0.909313,0.882249,0.857581,0.81367,0.786231,0.747981,0.646758,0.513449,0.324367,0.148368,0.0460029,0.00624878,0.00722291,0.0025344,0.000727273,0,0,0,0,
  0.920508,0.903516,0.879824,0.862668,0.830862,0.805965,0.752725,0.697385,0.626958,0.469973,0.257848,0.0884207,0.017218,0.0117677,0.0119002,0.00300752,0,0,0,0,
  0.925395,0.919095,0.891881,0.87242,0.848711,0.839727,0.770658,0.736037,0.722208,0.609424,0.400542,0.173757,0.0533829,0.0259577,0.0175841,0.00236407,0.00341297,0.0148148,0,0,
  0.934198,0.918964,0.906136,0.892563,0.882806,0.864083,0.841115,0.794982,0.754912,0.696114,0.571691,0.388197,0.179072,0.0456878,0.0127246,0.00212766,0,0.00666667,0,0,
  0.934077,0.924885,0.921048,0.920798,0.911884,0.889589,0.866879,0.838966,0.809253,0.77399,0.711864,0.582281,0.372774,0.245596,0.117813,0.0229976,0.00497512,0.03125,0,0,
  0.935653,0.933222,0.936563,0.92904,0.925825,0.907574,0.89127,0.874811,0.851754,0.81276,0.765769,0.678608,0.520842,0.41656,0.273693,0.11788,0.0323194,0.0267857,0,0,
  0.938228,0.937583,0.930941,0.92441,0.918689,0.924712,0.905707,0.880448,0.86694,0.831536,0.797472,0.755923,0.656926,0.443924,0.24084,0.0986938,0.0273723,0,0,0,
  0.945205,0.937675,0.929129,0.928076,0.923545,0.902194,0.889325,0.884461,0.847656,0.814443,0.755269,0.659964,0.52208,0.406234,0.284423,0.114089,0.0339286,0.04,0,0,
  0.932633,0.926269,0.92589,0.916497,0.914099,0.88822,0.867736,0.842266,0.807968,0.763176,0.715767,0.580727,0.37791,0.233994,0.129794,0.0333575,0.00189394,0.0325203,0,0,
  0.927326,0.921682,0.911702,0.902641,0.885119,0.859291,0.823571,0.799851,0.756247,0.691207,0.583708,0.39723,0.175807,0.0478165,0.00928571,0.00295639,0.00168067,0,0,0,
  0.918529,0.90962,0.887327,0.883156,0.85206,0.842829,0.773051,0.73913,0.722384,0.595759,0.404996,0.167889,0.0483714,0.0258114,0.0204396,0.00805153,0.00178253,0,0,0,
  0.878694,0.868519,0.873111,0.754774,0.685646,0.654398,0.532518,0.260257,0.0774002,0.0420416,0.062765,0.0633424,0.0570676,0.0516257,0.0614612,0.047927,0.0187668,0.019084,0.0555556,0,
  0.887488,0.868832,0.837483,0.812232,0.696169,0.569568,0.425167,0.255303,0.115374,0.0451236,0.0297588,0.0314928,0.0292793,0.0256798,0.0186534,0.013167,0.00515464,0,0,0,
  0.896552,0.863854,0.84503,0.819224,0.793918,0.7303,0.615882,0.452501,0.294553,0.164599,0.0631219,0.0248858,0.00390206,0.0042411,0.0036452,0.00373552,0.00330306,0.003861,0,0,
  0.880901,0.885248,0.869993,0.853399,0.831087,0.810222,0.768819,0.708145,0.662697,0.553971,0.381792,0.179977,0.0619331,0.021669,0.018456,0.00733308,0.0055814,0.00373134,0.0136986,0,
  0.900853,0.901958,0.895641,0.883828,0.874066,0.864273,0.856281,0.830003,0.790228,0.758712,0.71831,0.654299,0.503167,0.323315,0.14806,0.0462428,0.00707965,0,0,0,
  0.903805,0.909217,0.911044,0.915421,0.918201,0.911656,0.9089,0.894259,0.882445,0.861084,0.848562,0.828555,0.765625,0.697479,0.476093,0.204011,0.055912,0.0962963,0.0892857,0,
  0.903743,0.918792,0.918809,0.924177,0.927005,0.922328,0.922862,0.918514,0.913995,0.894422,0.889094,0.884509,0.851581,0.784254,0.640461,0.415493,0.161877,0.155039,0.137931,0,
  0.904634,0.909091,0.916885,0.918264,0.920905,0.922664,0.914016,0.903608,0.891622,0.871613,0.850418,0.822692,0.794611,0.745875,0.629252,0.459206,0.25974,0.0760456,0,0,
  0.90483,0.900754,0.909152,0.908534,0.907435,0.880389,0.871866,0.853589,0.830543,0.798217,0.744083,0.63974,0.509613,0.369526,0.294595,0.143417,0.0512821,0.0120482,0.0149254,0,
  0.898068,0.896635,0.887017,0.884131,0.871797,0.85049,0.829936,0.769344,0.692354,0.578101,0.423952,0.229341,0.0979584,0.04961,0.0223793,0.00913938,0.00174064,0.00383142,0,0,
  0.886963,0.874636,0.878039,0.875154,0.828299,0.746336,0.691982,0.589582,0.452009,0.26605,0.120943,0.0485604,0.0380236,0.043616,0.0435707,0.045186,0.0384615,0.0106383,0,0,
  0.883931,0.867956,0.877812,0.790519,0.722026,0.73642,0.656146,0.348223,0.109766,0.0487008,0.0653455,0.0711732,0.0623848,0.0590634,0.0614328,0.0729008,0.0468343,0.03663,0.0655738,0,
  0.850789,0.84475,0.781801,0.615723,0.460561,0.320656,0.198076,0.0846447,0.0420561,0.0444352,0.0459597,0.0457133,0.0389432,0.0429043,0.0279801,0.0247006,0.0084317,0,0,0,
  0.840426,0.832788,0.760393,0.62703,0.410952,0.212693,0.0836465,0.0439097,0.0370879,0.0332198,0.0272078,0.0242139,0.0135554,0.00964467,0.00762565,0.00401875,0.0113852,0.0153846,0,0,
  0.839234,0.835813,0.781582,0.610124,0.462361,0.325567,0.215027,0.0806106,0.0364673,0.0412685,0.0484663,0.0483308,0.0467914,0.0465469,0.0308404,0.0245536,0.0138169,0,0,0,
  0.853043,0.842517,0.814894,0.702848,0.636052,0.632331,0.542261,0.341397,0.112742,0.0574176,0.0563317,0.0681895,0.0675204,0.062838,0.068842,0.0661479,0.0551724,0.075188,0.0322581,0,
  0.858317,0.853376,0.861427,0.864096,0.812781,0.764244,0.727536,0.689794,0.619366,0.470762,0.322968,0.181423,0.100204,0.059985,0.0502251,0.0479406,0.0634391,0.08,0.153846,0,
  0.877866,0.865734,0.87148,0.874317,0.888934,0.881908,0.879737,0.853843,0.850456,0.805705,0.74574,0.658031,0.518997,0.350646,0.182757,0.0732303,0.0189003,0.0330578,0.04,0,
  0.88059,0.891406,0.898624,0.899611,0.910608,0.910429,0.907154,0.903213,0.901226,0.884727,0.881761,0.858458,0.839499,0.788093,0.684828,0.407658,0.201077,0.153285,0.153846,0,
  0.89006,0.89761,0.8942,0.911844,0.914574,0.920434,0.925161,0.920401,0.919009,0.914486,0.895675,0.88521,0.875504,0.858727,0.834367,0.812641,0.719536,0.620438,0.36,0,
  0.891841,0.892291,0.892717,0.900607,0.909766,0.912413,0.907146,0.903943,0.894453,0.870949,0.873804,0.864944,0.839699,0.796169,0.654023,0.410728,0.202847,0.137255,0.166667,0,
  0.880407,0.868839,0.875387,0.875653,0.874521,0.881124,0.877611,0.866059,0.837849,0.802754,0.746513,0.657466,0.513448,0.355383,0.185185,0.0720243,0.0275735,0.0138889,0,0,
  0.856346,0.845749,0.86345,0.855676,0.822752,0.766437,0.734437,0.687423,0.608812,0.468142,0.301682,0.186857,0.0976966,0.0605905,0.0421554,0.0535583,0.0525394,0.0839695,0.115385,0,
  0.860443,0.84358,0.828088,0.701675,0.636141,0.621696,0.54916,0.339605,0.117253,0.0592913,0.056601,0.0658004,0.0690178,0.0691889,0.0581905,0.0701079,0.0643382,0.0232558,0.0277778,0,
};


float RICHDB::lg_dist_tbl[RIC_NWND][RIC_NPHI][RIC_NTH]=
{1.024,1.035,1.050,1.071,1.099,1.136,1.175,1.226,1.284,1.335,1.352,1.375,1.400,1.257,1.262,0.000,0.000,0.000,0.000,0.000
,1.025,1.037,1.053,1.075,1.104,1.144,1.197,1.253,1.312,1.367,1.417,1.463,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000
,1.025,1.035,1.050,1.072,1.099,1.136,1.176,1.227,1.284,1.334,1.353,1.376,1.398,1.257,1.263,0.000,0.000,0.000,0.000,0.000
,1.023,1.031,1.042,1.059,1.082,1.113,1.144,1.183,1.236,1.287,1.301,1.326,1.362,1.318,1.234,0.000,0.000,0.000,0.000,0.000
,1.021,1.024,1.031,1.042,1.059,1.081,1.110,1.146,1.190,1.246,1.308,1.368,1.417,1.457,1.485,0.000,0.000,0.000,0.000,0.000
,1.019,1.018,1.021,1.028,1.039,1.054,1.074,1.101,1.136,1.182,1.237,1.285,1.325,1.337,1.350,1.405,0.000,1.238,0.000,0.000
,1.017,1.014,1.014,1.017,1.025,1.036,1.052,1.074,1.101,1.136,1.172,1.213,1.256,1.288,1.315,1.360,1.403,1.225,1.249,0.000
,1.017,1.012,1.011,1.013,1.019,1.029,1.044,1.063,1.089,1.121,1.164,1.221,1.288,1.346,1.401,1.451,1.492,0.000,0.000,0.000
,1.017,1.014,1.014,1.017,1.025,1.036,1.052,1.074,1.100,1.136,1.173,1.215,1.260,1.293,1.321,1.365,1.401,1.228,1.251,0.000
,1.019,1.018,1.021,1.028,1.039,1.054,1.074,1.101,1.136,1.182,1.236,1.286,1.326,1.338,1.348,1.405,0.000,1.237,0.000,0.000
,1.021,1.024,1.032,1.042,1.059,1.081,1.111,1.146,1.190,1.245,1.307,1.368,1.416,1.459,1.489,0.000,0.000,0.000,0.000,0.000
,1.023,1.030,1.042,1.059,1.082,1.113,1.144,1.182,1.236,1.287,1.300,1.324,1.354,1.304,1.231,0.000,0.000,0.000,0.000,0.000
,1.086,1.114,1.149,1.179,1.215,1.289,1.356,1.392,1.354,1.177,1.144,1.169,1.171,1.217,1.277,1.302,1.379,1.397,1.420,0.000
,1.084,1.109,1.142,1.180,1.218,1.265,1.322,1.370,1.398,1.358,1.279,1.285,1.317,1.353,1.409,1.470,0.000,0.000,0.000,0.000
,1.081,1.097,1.119,1.150,1.190,1.234,1.280,1.325,1.370,1.413,1.437,1.427,0.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000
,1.075,1.080,1.089,1.106,1.127,1.157,1.187,1.224,1.267,1.307,1.326,1.332,1.359,1.378,1.271,1.275,0.000,0.000,0.000,0.000
,1.070,1.065,1.064,1.068,1.076,1.089,1.107,1.130,1.155,1.189,1.231,1.277,1.322,1.373,1.433,1.496,0.000,0.000,0.000,0.000
,1.066,1.054,1.047,1.042,1.042,1.045,1.052,1.062,1.078,1.098,1.126,1.160,1.204,1.259,1.313,1.373,1.477,1.376,1.431,0.000
,1.064,1.049,1.039,1.032,1.029,1.029,1.032,1.039,1.050,1.066,1.087,1.113,1.147,1.189,1.237,1.299,1.387,1.373,1.408,0.000
,1.065,1.052,1.043,1.038,1.036,1.038,1.044,1.054,1.068,1.087,1.112,1.144,1.181,1.230,1.290,1.358,1.424,1.486,1.543,0.000
,1.069,1.061,1.058,1.059,1.065,1.074,1.089,1.107,1.133,1.167,1.203,1.231,1.266,1.297,1.318,1.348,1.396,1.317,1.262,0.000
,1.075,1.078,1.085,1.096,1.114,1.137,1.166,1.201,1.241,1.289,1.340,1.372,1.398,1.381,1.402,1.438,0.000,0.000,0.000,0.000
,1.080,1.095,1.115,1.140,1.165,1.193,1.245,1.305,1.355,1.391,1.390,1.307,1.198,1.221,1.263,1.328,1.399,1.447,0.000,0.000
,1.085,1.108,1.139,1.166,1.198,1.265,1.332,1.365,1.339,1.206,1.115,1.148,1.139,1.156,1.203,1.249,1.291,1.349,1.378,0.000
,1.149,1.189,1.227,1.263,1.301,1.357,1.400,1.406,1.287,1.213,1.226,1.241,1.274,1.331,1.337,1.395,1.484,0.000,0.000,0.000
,1.153,1.198,1.242,1.289,1.335,1.378,1.400,1.381,1.352,1.386,1.407,1.408,1.419,1.427,0.000,0.000,0.000,0.000,1.307,0.000
,1.150,1.188,1.228,1.263,1.302,1.356,1.402,1.405,1.284,1.211,1.226,1.240,1.275,1.331,1.337,1.393,0.000,0.000,0.000,0.000
,1.142,1.166,1.192,1.209,1.239,1.300,1.357,1.384,1.367,1.249,1.150,1.150,1.166,1.172,1.212,1.248,1.273,1.328,1.380,0.000
,1.133,1.139,1.150,1.164,1.179,1.197,1.230,1.274,1.315,1.347,1.372,1.384,1.358,1.252,1.184,1.210,1.259,1.319,1.356,0.000
,1.125,1.115,1.111,1.111,1.114,1.122,1.133,1.148,1.167,1.194,1.228,1.265,1.303,1.345,1.393,1.455,1.449,1.460,1.494,0.000
,1.119,1.098,1.083,1.073,1.067,1.065,1.066,1.070,1.079,1.092,1.110,1.133,1.163,1.202,1.241,1.274,1.323,1.380,1.406,0.000
,1.117,1.092,1.075,1.062,1.053,1.047,1.045,1.046,1.050,1.059,1.072,1.090,1.113,1.142,1.178,1.227,1.292,1.369,1.416,0.000
,1.119,1.097,1.083,1.073,1.067,1.064,1.065,1.070,1.079,1.092,1.110,1.133,1.163,1.202,1.241,1.275,1.326,1.383,1.409,0.000
,1.125,1.114,1.110,1.110,1.114,1.121,1.133,1.148,1.168,1.196,1.228,1.265,1.304,1.344,1.394,1.453,1.443,1.460,1.498,0.000
,1.133,1.139,1.150,1.164,1.179,1.197,1.233,1.280,1.321,1.352,1.373,1.383,1.353,1.254,1.182,1.208,1.258,1.319,1.360,0.000
,1.142,1.166,1.192,1.209,1.238,1.300,1.358,1.386,1.372,1.236,1.142,1.149,1.166,1.173,1.212,1.247,1.272,1.322,1.371,0.000};






integer RICHDB::get_wavelength_bin(geant wl){
  // Use binary search to find the bin
  // It assumes the wave length array is sorted in descending order

  if(wl>=wave_length[0]) return 0;
  if(wl<wave_length[RICmaxentries-1]) return RICmaxentries-1;

  int bin_max=RICmaxentries-1;
  int bin_min=0;

  for(;;){
    int bin_med=(bin_max+bin_min)/2;
    if(wl<wave_length[bin_med]) bin_min=bin_med; else bin_max=bin_med;
    if(bin_max-bin_min<=1) break;
  }
  
  return bin_min;

}

//
// Test if the media is a radiator within fortran. To be used in gtckov
//

extern "C" integer testradiator_(integer *numed){
  if(*numed==RICHDB::agl_media) return 1;
  if(*numed==RICHDB::naf_media) return 2;
  return 0;
}


//
// Alignment class
//


AMSPoint  RichAlignment::_a2rShift;
AMSPoint  RichAlignment::_r2aShift;
AMSRotMat RichAlignment::_a2rRot;
AMSRotMat RichAlignment::_r2aRot;

void RichAlignment::LoadFile(char *filename){
  if(!filename || strlen(filename)==0){
    cout<<"RichAlignment::LoadFile -- problem with file name... Ignoring."<<endl;
    return;
  }

  fstream stream;
  stream.open(filename,fstream::in);
  if(!stream.is_open() || stream.fail()){
    cout<<"RichAlignment::LoadFile -- problem opening file "<<filename<<" ... Ignoring."<<endl;
    return;
  }

  cout<<"RichAlignment::LoadFile -- loading "<<filename<<endl;

  // Read the following components of the a2r matrixes
  double sx,sy,sz;
  double alpha,beta,gamma;

  stream>>sx>>sy>>sz;

  if(stream.eof()){
    cout<<"RichAlignment::LoadFile -- truncated... Ingnoring "<<filename<<endl;
  }

  stream>>alpha>>beta>>gamma;


  if(stream.eof()){
    cout<<"RichAlignment::LoadFile -- truncated... Ingnoring "<<filename<<endl;
  }

  stream.close();

#ifdef __AMSDEBUG__
  cout<<"RICH ALIGNMENT PARAMETERS --- "<<sx<<" "<<sy<<" "<<sz<<" --- "<<alpha<<" "<<beta<<" "<<gamma<<endl;
#endif

  // Fill the a2r shift and matrix
  _a2rShift.setp(sx,sy,sz);
  _a2rRot.SetRotAngles(alpha,beta,gamma);

#ifdef __AMSDEBUG__
  _a2rShift.getp(sx,sy,sz);
  _a2rRot.GetRotAngles(alpha,beta,gamma);

  cout<<" --- RECOVERED RICH ALIGNMENT PARAMETERS --- "<<sx<<" "<<sy<<" "<<sz<<" --- "<<alpha<<" "<<beta<<" "<<gamma<<endl;
#endif


  // Fill the r2a shift and matrix
  AMSRotMat t;
  _r2aRot.SetRotAngles(0,0,-gamma);
  t.SetRotAngles(0,-beta,0);
  _r2aRot=t*_r2aRot;
  t.SetRotAngles(-alpha,0,0);
  _r2aRot=t*_r2aRot;
  _r2aShift=(_r2aRot*_a2rShift)*-1.0;
  
  // Check that the result is acceptable
  AMSRotMat test_m=_r2aRot*_a2rRot;
  test_m.GetRotAngles(alpha,beta,gamma);

  AMSPoint test_p=_a2rShift;
  test_p=(_r2aRot*test_p)+_r2aShift;
  test_p.getp(sx,sy,sz);

#ifdef __AMSDEBUG__
  cout<<" -- RICH AFTER INVERTING --- "<<sx<<" "<<sy<<" "<<sz<<" --- "<<alpha<<" "<<beta<<" "<<gamma<<endl;
#endif

  if(!(fabs(alpha)<0.5e-4 && fabs(beta)<0.5e-4 && fabs(gamma)<0.5e-4)){
    cout<<"RichAlignment::LoadFile -- problem with rotation matrix "<<alpha<<" "<<beta<<" "<<gamma<<". Ignoring"<<endl;
    _r2aRot.Reset();
    _a2rRot.Reset();
  }
  if(!(fabs(sx)<0.5e-2 && fabs(sy)<0.5e-2 && fabs(sz)<0.5e-2)){
    cout<<"RichAlignment::LoadFile -- problem with shift vector "<<sx<<" "<<sy<<" "<<sz<<". Ignoring"<<endl;
    _r2aShift.setp(0,0,0);
    _a2rShift.setp(0,0,0);
  }
}

void RichAlignment::Init(){
  // If this is cosmics and real data, load the cosmics alignment.
  // This should be moved to database in some moment 
  char name[801];


  // Ensure that the initialization is done only once and is visible by all the threads 
  // Has the single an implicit barrier? Just in case we add them
#pragma omp barrier
#pragma omp master
  if(AMSJob::gethead()->isRealData()  &&              // It is real data
     //     MISCFFKEY.BeamTest==1 &&                         // It is a cosmic run
     strstr(AMSJob::gethead()->getsetup(),"PreAss")){  // It is the preassembly one
    sprintf(name,"%s/%s/RichAlignmentCosmic.1207904521.2.dat",getenv("AMSDataDir"),AMSCommonsI::getversion());
    LoadFile(name);
  }
#pragma omp barrier

}
